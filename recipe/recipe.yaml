context:
  name: rattler-build
  version: "0.58.0"

package:
  name: ${{ name }}
  version: ${{ version }}

source:
  url: https://github.com/prefix-dev/rattler-build/archive/refs/tags/v${{ version }}.tar.gz
  sha256: 3a0c2a266a1e1572e5e55619f02718627c513a49e44c1df8b54675b1e5bb9d49

build:
  script:
    env:
      CARGO_PROFILE_RELEASE_STRIP: symbols
      CARGO_PROFILE_RELEASE_LTO: ${{ "fat" if not linux and (aarch64 or ppc64le) else "thin" }}
    content:
      - if: osx and x86_64
        then:
          - if [[ "${MACOSX_SDK_VERSION}" != "11.0" ]]; then exit 1; fi
          # use the default linker for macOS as we are hitting a bug with the conda-forge linker
          - unset CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER
      - if: unix
        then:
          # Unix recipe
          - export OPENSSL_DIR="$PREFIX"
          - if: target_platform == "linux-ppc64le"
            then:
              - cargo auditable install --locked --no-default-features --features native-tls,recipe-generation,s3,performance --bin rattler-build --root ${PREFIX} --path . --no-track
            else:
              - cargo auditable install --locked --no-default-features --features native-tls,recipe-generation,s3,sigstore,performance --bin rattler-build --root ${PREFIX} --path . --no-track
          - cargo-bundle-licenses --format yaml --output ${SRC_DIR}/THIRDPARTY.yml
          - mkdir -p $PREFIX/share/zsh/site-functions
          - $PREFIX/bin/rattler-build completion --shell zsh > $PREFIX/share/zsh/site-functions/_rattler-build
          - mkdir -p $PREFIX/share/bash-completion/completions
          - $PREFIX/bin/rattler-build completion --shell bash > $PREFIX/share/bash-completion/completions/rattler-build
          - mkdir -p $PREFIX/share/fish/vendor_completions.d
          - $PREFIX/bin/rattler-build completion --shell fish > $PREFIX/share/fish/vendor_completions.d/rattler-build.fish
        else:
          # Win recipe
          # hack: path too long for pixi_config subpackage, https://github.com/prefix-dev/pixi/issues/3691
          - set CARGO_HOME=C:\.cargo
          - md %CARGO_HOME%
          - cargo auditable install --locked --no-default-features --features native-tls,recipe-generation,s3,sigstore,performance --bin rattler-build --root %PREFIX% --path . --no-track
          - cargo-bundle-licenses --format yaml --output %SRC_DIR%/THIRDPARTY.yml
  number: 0

requirements:
  build:
    - ${{ compiler('rust') }}
    - ${{ stdlib('c') }}
    - ${{ compiler('c') }}
    - ${{ compiler('cxx') }}
    - if: unix
      then: make
    - cargo-auditable
    - cargo-bundle-licenses
  host:
    - ${{ "openssl" if linux }}
  run:
    - ${{ "patchelf" if linux }}

tests:
  - package_contents:
      bin:
        - rattler-build
      files:
        - etc/conda/test-files/rattler-build/0/test-recipe/check.yaml
        - if: unix
          then:
            - share/zsh/site-functions/_rattler-build
            - share/bash-completion/completions/rattler-build
            - share/fish/vendor_completions.d/rattler-build.fish
      strict: true
  - script:
      - rattler-build --help
      - if: unix
        then:
          # check that we can fetch the sourcecode for slepc
          - rattler-build build --recipe ./test-recipe/check.yaml
        else:
          - rattler-build build --recipe ./test-recipe/check.yaml --output-dir %PREFIX%/out
    files:
      recipe:
        - test-recipe/


about:
  homepage: https://github.com/prefix-dev/rattler-build
  summary: rattler-build is the universal conda package builder for Windows, macOS and Linux
  description: |
    The rattler-build tooling and library creates cross-platform relocatable binaries / packages
    from a simple recipe format.
    The recipe format is heavily inspired by conda-build and boa, and the output of a regular
    rattler-build run is a package that can be installed using mamba, conda or rattler.
  license: BSD-3-Clause
  license_file:
    - LICENSE
    - THIRDPARTY.yml
    - CONDA_BUILD_LICENSE.txt
  documentation: https://rattler.build

extra:
  recipe-maintainers:
    - nichmor
    - wolfv
    - pavelzw
    - '0xbe7a'
