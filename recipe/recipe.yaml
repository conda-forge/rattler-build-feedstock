context:
  name: rattler-build
  version: "0.57.0"

package:
  name: ${{ name }}
  version: ${{ version }}

source:
  # url: https://github.com/prefix-dev/rattler-build/archive/refs/tags/v${{ version }}.tar.gz
  # sha256: cdc4a8a49b5accd107baffc64ee30be91eccfde995f159217605bf80b6c8854b
  url: https://github.com/prefix-dev/rattler-build/archive/41b0d3ed6d8981e67bbc316f2f3295e84566d48b.tar.gz
  sha256: cb0168d17ca19946a4fefdf9b59875a6adf00c66b66c4d317be0d8b717a3dea9

build:
  script:
    - if: osx and x86_64
      then:
        - if [[ "${MACOSX_SDK_VERSION}" != "11.0" ]]; then exit 1; fi
        # use the default linker for macOS as we are hitting a bug with the conda-forge linker
        - unset CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER

    # For now, disable Assembly on win-arm64
    - if: target_platform == 'win-arm64'
      then:
        - set AWS_LC_SYS_NO_ASM=1

    - if: unix
      then:
        # Unix recipe
        - export OPENSSL_DIR="$PREFIX"
        - cargo install --locked --no-default-features --features native-tls,recipe-generation,s3,sigstore --bin rattler-build --root ${PREFIX} --path . --no-track
        # https://github.com/sstadick/cargo-bundle-licenses/issues/49
        - cargo-bundle-licenses --features native-tls,recipe-generation,s3,sigstore --format yaml --output ${SRC_DIR}/THIRDPARTY.yml
      else:
        # Win recipe
        # hack: path too long for pixi_config subpackage, https://github.com/prefix-dev/pixi/issues/3691
        - set CARGO_HOME=C:\.cargo
        - md %CARGO_HOME%
        # s3 feature requires clang: https://github.com/conda-forge/clang-win-activation-feedstock/issues/63
        - cargo install --locked --no-default-features --features native-tls,recipe-generation${{ ',s3,sigstore' if target_platform != 'win-arm64' else '' }} --bin rattler-build --root %PREFIX% --path . --no-track
        - if errorlevel 1 exit 1
        # https://github.com/sstadick/cargo-bundle-licenses/issues/49
        - cargo-bundle-licenses --features native-tls,recipe-generation${{ ',s3,sigstore' if target_platform != 'win-arm64' else '' }} --format yaml --output %SRC_DIR%/THIRDPARTY.yml
        - if errorlevel 1 exit 1
  number: 1

requirements:
  build:
    - ${{ compiler('rust') }}
    - ${{ stdlib('c') }}
    - ${{ compiler('c') }}
    - cargo-bundle-licenses
  host:
    - ${{ "openssl" if linux }}
  run:
    - ${{ "patchelf" if linux }}

tests:
  - package_contents:
      bin:
        - rattler-build
      files:
        - etc/conda/test-files/rattler-build/0/test-recipe/check.yaml
      strict: true
  - script:
      - rattler-build --help
      - if: unix
        then:
          # check that we can fetch the sourcecode for slepc
          - rattler-build build --recipe ./test-recipe/check.yaml
        else:
          - rattler-build build --recipe ./test-recipe/check.yaml --output-dir %PREFIX%/out
    files:
      recipe:
        - test-recipe/

about:
  homepage: https://github.com/prefix-dev/rattler-build
  summary: rattler-build is the universal conda package builder for Windows, macOS and Linux
  description: |
    The rattler-build tooling and library creates cross-platform relocatable binaries / packages
    from a simple recipe format.
    The recipe format is heavily inspired by conda-build and boa, and the output of a regular
    rattler-build run is a package that can be installed using mamba, conda or rattler.
  license: BSD-3-Clause
  license_file:
    - LICENSE
    - THIRDPARTY.yml
    - CONDA_BUILD_LICENSE.txt
  documentation: https://rattler.build

extra:
  recipe-maintainers:
    - nichmor
    - wolfv
    - pavelzw
    - "0xbe7a"
